<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Ensuring UTF-8 encoding for foreign characters -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Gemara Makkos Jeopardy</title>
  <style>
    /* General Styles */
    body {
      font-family: Arial, sans-serif;
      background-color: var(--background-color, #1a1a1a);
      color: var(--text-color, #fff);
      margin: 0;
      padding: 0;
    }
    /* Game Board Styles */
    #game-board {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(5, 80px);
      gap: 2px;
      width: 100%;
      max-width: 1000px;
      margin: 20px auto;
    }
    .question {
      background-color: var(--grid-cell-color, #0047ab);
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.5em;
      cursor: pointer;
      text-align: center;
      color: var(--text-color, #fff);
    }
    .question.answered {
      background-color: var(--background-color, #1a1a1a);
      color: var(--background-color, #1a1a1a);
      cursor: default;
    }
    /* Scoreboard Styles */
    .scoreboard {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #333;
      padding: 10px;
      position: relative;
    }
    .score,
    .turn-indicator {
      font-size: 1.5em;
    }
    .scoreboard.hidden {
      display: none !important;
    }
    /* Modals */
    .modal,
    .result-modal,
    .end-game-modal,
    .settings-modal,
    .game-clock-modal,
    .scoreboard-modal,
    .superpowers-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      justify-content: center;
      align-items: center;
      color: white;
      z-index: 1000;
    }
    .modal-content,
    .result-modal-content,
    .end-game-modal-content,
    .game-clock-modal-content {
      background: #222;
      padding: 20px;
      text-align: center;
      border-radius: 8px;
      max-width: 800px;
      width: 90%;
    }
    .settings-modal-content,
    .scoreboard-modal-content,
    .superpowers-modal-content {
      background: #222;
      padding: 20px;
      text-align: center;
      border-radius: 8px;
      max-width: 800px;
      width: 90%;
      max-height: 80vh; /* Limit the modal's height */
      overflow-y: auto; /* Add vertical scroll if content overflows */
    }
    .options button,
    .controls button,
    .start-screen button,
    .instruction-screen button,
    #start-timer-button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background-color: var(--button-color, #f3c300);
      color: #000;
    }
    .start-screen,
    .instruction-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: var(--text-color, #fff);
      margin: 20px;
    }
    .team-input-row {
      margin: 5px;
    }
    .team-input-row input {
      margin-left: 10px;
      padding: 5px;
      font-size: 1em;
      width: 180px;
    }
    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px;
      position: relative;
    }
    /* Timer Display */
    #timer-display {
      font-size: 1.5em;
      margin: 10px 0;
      color: var(--question-text-color, #fff);
    }
    /* Correct and Incorrect Buttons */
    .correct-button {
      background-color: green;
      color: white;
      width: 150px;
    }
    .incorrect-button {
      background-color: red;
      color: white;
      width: 150px;
    }
    /* Gear Icon */
    .gear-button {
      background: none;
      border: none;
      cursor: pointer;
      position: absolute;
      bottom: 10px;
      right: 10px;
    }
    .gear-icon {
      width: 30px;
      height: 30px;
      fill: var(--text-color, #fff);
    }
    /* Settings Form */
    .settings-form label {
      display: block;
      margin: 10px 0 5px;
    }
    .settings-form input[type="color"],
    .settings-form input[type="number"],
    .settings-form input[type="time"] {
      width: 100%;
      height: 40px;
      border: none;
      cursor: pointer;
    }
    .settings-form input[type="checkbox"] {
      margin-right: 5px;
    }
    .settings-form .checkbox-group {
      text-align: left;
      margin: 10px 0;
    }
    .settings-form .number-input-group {
      margin: 10px 0;
      display: none;
    }
    /* Responsive Design */
    @media (max-width: 768px) {
      .category,
      .question {
        font-size: 1em;
      }
      .score,
      .turn-indicator {
        font-size: 1.2em;
      }
    }
  </style>
</head>

<body>
  <!-- Instruction Screen -->
  <div class="instruction-screen" id="instruction-screen">
    <h2>How to Play Jeopardy</h2>
    <p>Welcome to Jeopardy! This game is designed to help you learn and review material in a fun and interactive way.</p>
    <h3>Game Rules:</h3>
    <ul>
      <li>The game can be played between two or more teams.</li>
      <li>Teams take turns selecting questions from the game board.</li>
      <li>Each question has a point value. Correct answers earn points; incorrect answers deduct points based on the round.</li>
      <li>If you get a question wrong in round one, half the value of the question will be deducted from your score. In round 2, you lose the full value, round 3 is double, etc.</li>
      <li>If a team answers incorrectly, another team can try. (For 2 teams, it passes over immediately. For more teams, you may rotate turns.)</li>
      <li>If a team's score reaches -$500 or lower, their score resets to $0.</li>
      <li>Once all questions are answered or the game is ended early, the team with the higher score wins!</li>
    </ul>
    <button onclick="goToStartScreen()">Start</button>
  </div>

  <!-- Team Name Screen -->
  <div class="start-screen" id="start-screen" style="display: none;">
    <button class="gear-button" onclick="openSettings()">
      <!-- Gear Icon -->
      <svg class="gear-icon" viewBox="0 0 24 24">
        <path
          d="M12 15.5a3.5 3.5 0 1 0 0-7 
             3.5 3.5 0 0 0 0 7zm7.07-6.02l1.43-1.43-1.41-1.41-1.43 
             1.43A7.975 7.975 0 0 0 13 4.93V3h-2v1.93a7.975 
             7.975 0 0 0-3.66 1.64L5.93 5.07 4.5 6.5l1.43 
             1.43A7.975 7.975 0 0 0 4.93 11H3v2h1.93a7.975 
             7.975 0 0 0 1.64 3.66L5.07 18.07l1.41 1.41 
             1.43-1.43A7.975 7.975 0 0 0 11 19.07V21h2v-1.93a7.975 
             7.975 0 0 0 3.66-1.64l1.43 
             1.43 1.41-1.41-1.43-1.43A7.975 7.975 0 0 0 19.07 13H21v-2h-1.93a7.975 
             7.975 0 0 0-1.64-3.66zM12 17a5 
             5 0 1 1 0-10 5 5 0 0 1 0 10z"
        />
      </svg>
    </button>
    <h2>Enter Team Names and Upload Question Bank</h2>
    <div id="teams-container">
      <!-- We will dynamically add team input rows here -->
    </div>
    <button onclick="addTeam()">Add Team</button>
    <button onclick="deleteTeam()">Delete Team</button>
    <br /><br />
    <input type="file" id="csv-file" accept=".csv" />
    <button id="start-game-button" onclick="startGame()" disabled>Start Game</button>
  </div>

  <!-- Scoreboard (for 2 teams) -->
  <div class="scoreboard" style="display: none;" id="scoreboard">
    <div class="score" id="team1-score">Team 1: $0</div>
    <div class="turn-indicator" id="turn-indicator">Turn: Team 1</div>
    <div class="score" id="team2-score">Team 2: $0</div>
  </div>

  <!-- If more than 2 teams, show a button in top-right corner to open scoreboard modal -->
  <button
    id="show-scores-button"
    style="display: none; position: absolute; top: 10px; right: 10px; z-index: 2000;"
    onclick="openScoreboardModal()"
  >
    Show Scores
  </button>

  <!-- Dynamic Board -->
  <div class="board" id="game-board" style="display: none;"></div>

  <div class="controls" style="display: none;" id="controls">
    <button onclick="endGameEarly()">End Game</button>
    <button id="next-round-button" onclick="goToNextRound()" style="display: none;">
      Next Round
    </button>

    <!-- Superpowers button (shown only if superpowers are enabled) -->
    <button id="superpowers-button" style="display:none; margin-left: 15px;" onclick="openSuperpowersModal()">
      Superpowers
    </button>

    <button class="gear-button" onclick="openSettings()">
      <!-- Gear Icon -->
      <svg class="gear-icon" viewBox="0 0 24 24">
        <path
          d="M12 15.5a3.5 3.5 0 1 0 0-7 
             3.5 3.5 0 0 0 0 7zm7.07-6.02l1.43-1.43-1.41-1.41-1.43 
             1.43A7.975 7.975 0 0 0 13 4.93V3h-2v1.93a7.975 
             7.975 0 0 0-3.66 1.64L5.93 5.07 4.5 6.5l1.43 
             1.43A7.975 7.975 0 0 0 4.93 11H3v2h1.93a7.975 
             7.975 0 0 0 1.64 3.66L5.07 18.07l1.41 1.41 
             1.43-1.43A7.975 7.975 0 0 0 11 19.07V21h2v-1.93a7.975 
             7.975 0 0 0 3.66-1.64l1.43 
             1.43 1.41-1.41-1.43-1.43A7.975 7.975 0 0 0 19.07 13H21v-2h-1.93a7.975 
             7.975 0 0 0-1.64-3.66zM12 17a5 
             5 0 1 1 0-10 5 5 0 0 1 0 10z"
        />
      </svg>
    </button>
  </div>

  <!-- Modal for Question Display -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <h3 id="current-team"></h3>
      <h2 id="question-text"></h2>
      <div id="timer-display"></div>
      <button id="start-timer-button" onclick="startTimer()">Start Timer</button>
      <div class="options" id="options"></div>
    </div>
  </div>

  <!-- Result Modal -->
  <div class="result-modal" id="result-modal">
    <div class="result-modal-content">
      <p id="result-message"></p>
      <button onclick="closeResultModal()">Close</button>
    </div>
  </div>

  <!-- End Game Modal -->
  <div class="end-game-modal" id="end-game-modal">
    <div class="end-game-modal-content">
      <h2 id="end-game-message"></h2>
      <button onclick="playNewGame()">Play Again</button>
    </div>
  </div>

  <!-- Game Clock Modal -->
  <div class="game-clock-modal" id="game-clock-modal">
    <div class="game-clock-modal-content">
      <h2 id="game-clock-modal-title">Game Clock Time Up</h2>
      <p>What would you like to do?</p>
      <button onclick="addTime(5)">Add 5 Minutes</button>
      <button onclick="showCustomTimeInput()">Add Custom Time</button>
      <div id="custom-time-input" style="display: none;">
        <input type="number" id="custom-time-minutes" placeholder="Minutes" min="1" />
        <button onclick="addCustomTime()">Add Time</button>
      </div>
      <button onclick="turnOffGameClock()">Turn Off Timer</button>
      <button onclick="endGame()">End Game</button>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="settings-modal" id="settings-modal">
    <div class="settings-modal-content">
      <h2>Game Settings</h2>
      <form class="settings-form" onsubmit="saveSettings(event)">
        <label for="background-color-picker">Background Color:</label>
        <input type="color" id="background-color-picker" value="#1a1a1a" />

        <label for="grid-cell-color-picker">Grid Cell Color:</label>
        <input type="color" id="grid-cell-color-picker" value="#0047ab" />

        <label for="button-color-picker">Button Color:</label>
        <input type="color" id="button-color-picker" value="#f3c300" />

        <label for="text-color-picker">Text Color:</label>
        <input type="color" id="text-color-picker" value="#ffffff" />

        <label for="question-text-color-picker">Question Text Color:</label>
        <input type="color" id="question-text-color-picker" value="#ffffff" />

        <div class="checkbox-group">
          <label><input type="checkbox" id="use-rounds-checkbox" checked /> Enable Rounds</label>
        </div>

        <div class="checkbox-group">
          <label><input type="checkbox" id="variable-rounds-checkbox" /> Enable variable number of rounds</label>
        </div>
        <div class="number-input-group" id="rounds-settings">
          <label for="max-rounds-input">Number of Rounds:</label>
          <input type="number" id="max-rounds-input" value="3" min="1" />
        </div>

        <div class="checkbox-group">
          <label><input type="checkbox" id="random-bonus-checkbox" /> Random Bonus Value</label>
        </div>
        <div class="number-input-group" id="bonus-settings">
          <label for="bonus-points-input">Bonus Points:</label>
          <input type="number" id="bonus-points-input" value="100" min="1" />
          <label for="bonus-chance-input">Chance of Bonus (%):</label>
          <input type="number" id="bonus-chance-input" value="10" min="1" max="100" />
        </div>

        <div class="checkbox-group">
          <label><input type="checkbox" id="enable-stopwatch-checkbox" /> Enable Stopwatch</label>
        </div>

        <div class="checkbox-group">
          <label><input type="checkbox" id="enable-gameclock-checkbox" /> Enable Game Clock</label>
        </div>
        <div class="number-input-group" id="gameclock-settings">
          <label for="gameclock-minutes-input">Game Clock Duration (minutes):</label>
          <input type="number" id="gameclock-minutes-input" value="60" min="1" />
          <div class="checkbox-group">
            <label><input type="checkbox" id="warn-five-minutes-checkbox" /> Warn when 5 minutes left</label>
          </div>
        </div>

        <div class="checkbox-group">
          <label><input type="checkbox" id="enable-endtime-checkbox" /> Set End Time</label>
        </div>
        <div class="number-input-group" id="endtime-settings">
          <label for="endtime-input">End Time:</label>
          <input type="time" id="endtime-input" />
          <div class="checkbox-group">
            <label><input type="checkbox" id="warn-five-minutes-endtime-checkbox" /> Warn when 5 minutes left</label>
          </div>
        </div>

        <!-- Superpowers Setting -->
        <div class="checkbox-group">
          <label><input type="checkbox" id="enable-superpowers-checkbox" /> Superpowers</label>
        </div>

        <button type="submit">Save Settings</button>
      </form>

      <div id="stopwatch-display" style="display: none;">
        <h3>Game Stopwatch:</h3>
        <p id="stopwatch-time">00:00:00</p>
      </div>
    </div>
  </div>

  <!-- Scoreboard Modal for 3+ teams -->
  <div class="scoreboard-modal" id="scoreboard-modal">
    <div class="scoreboard-modal-content" id="scoreboard-modal-content">
      <h2>Scoreboard</h2>
      <div id="all-teams-score"></div>
      <button onclick="closeScoreboardModal()">Close</button>
    </div>
  </div>

  <!-- SUPERPOWERS MODAL (UPDATED FOR USER-FRIENDLINESS) -->
  <div class="superpowers-modal" id="superpowers-modal">
    <div class="superpowers-modal-content" id="superpowers-modal-content">
      <h2>Superpowers Menu</h2>
      <p>Choose a superpower below. Once you use it, your turn ends immediately!</p>

      <div id="superpowers-list"></div>

      <!-- “Close” in case they change their mind -->
      <button onclick="closeSuperpowersModal()">Close</button>
    </div>
  </div>

  <script>
    /************************************************************/
    /*               TEAMS & CORE GAME VARIABLES               */
    /************************************************************/
    let maxTeams = 21;
    let teams = [
      { name: "Team 1", score: 0 },
      { name: "Team 2", score: 0 }
    ];
    let currentTeamIndex = 0;
    let secondChance = false; // For 2-team logic
    let totalQuestions = 25; // Will be updated after parsing CSV
    let remainingQuestions = totalQuestions;
    let questionBank = []; // Will be populated after parsing CSV
    let selectedQuestions = {};
    let usedQuestions = [];
    let currentRound = 1;
    let maxRounds = 3; // can be changed in settings

    // The main settings object
    const settings = {
      useRounds: true,
      variableRounds: false,
      maxRounds: 3,
      colors: {
        backgroundColor: "#1a1a1a",
        gridCellColor: "#0047ab",
        buttonColor: "#f3c300",
        textColor: "#ffffff",
        questionTextColor: "#ffffff"
      },
      randomBonus: false,
      bonusPoints: 100,
      bonusChance: 10,
      enableStopwatch: false,
      enableGameClock: false,
      gameClockMinutes: 60,
      warnFiveMinutes: false,
      enableEndTime: false,
      endTime: null,
      warnFiveMinutesEndTime: false,

      // superpowers
      superpowersEnabled: false
    };

    // Timer & clock variables
    let timerInterval = null;
    let timeRemaining = 0;
    let answerStartTime = null;

    let stopwatchInterval = null;
    let stopwatchTime = 0; // ms
    let stopwatchRunning = false;

    let gameClockInterval = null;
    let gameClockTimeRemaining = 0;
    let gameClockRunning = false;

    let endTimeInterval = null;
    let endTimeRunning = false;
    let endTimeWarned = false;

    /************************************************************/
    /*               SUPERPOWERS DEFINITION (UPDATED)           */
    /************************************************************/
    const SUPERPOWERS = [
      {
        id: "randomOutcome",
        label: "Link Random Outcome",
        cost: 200,
        description: "For the next 5 turns, one random outcome from another team’s turn is duplicated for you.",
        requiresTarget: false,
        action: (buyerIndex) => {
          teams[buyerIndex].score -= 200;
          alert(`${teams[buyerIndex].name} purchased "Link Random Outcome" ($200)!`);
          // TODO: implement effect tracking for next 5 turns
        }
      },
      {
        id: "skipTurn",
        label: "Skip Opponent’s Turn",
        cost: 300,
        description: "Skip the next turn of your chosen opposing team. They lose that selection opportunity.",
        requiresTarget: true,
        action: (buyerIndex, targetIndex) => {
          teams[buyerIndex].score -= 300;
          // TODO: mark that targetIndex's next turn is skipped
          alert(`${teams[buyerIndex].name} spent $300 to skip ${teams[targetIndex].name}'s next turn!`);
        }
      },
      {
        id: "removeChoices",
        label: "Remove Multiple Choice",
        cost: 100,
        description: "For the chosen team’s next question, remove or reduce their multiple-choice options.",
        requiresTarget: true,
        action: (buyerIndex, targetIndex) => {
          teams[buyerIndex].score -= 100;
          // TODO: track that targetIndex’s next question has fewer/no choices
          alert(`${teams[buyerIndex].name} spent $100 to remove multiple-choice for ${teams[targetIndex].name}!`);
        }
      },
      {
        id: "renameTeam",
        label: "Rename Your Team",
        cost: 0,
        description: "Change your own team name at no cost.",
        requiresTarget: false,
        action: (buyerIndex) => {
          const oldName = teams[buyerIndex].name;
          const newName = prompt(`Enter new name for ${oldName}:`, oldName);
          if (newName && newName.trim() !== "") {
            teams[buyerIndex].name = newName.trim();
            alert(`Team renamed from "${oldName}" to "${teams[buyerIndex].name}"!`);
          }
        }
      },
      {
        id: "chooseQuestionValue",
        label: "Choose Opponent's Next Question Value",
        cost: 300,
        description: "You decide the point value for the chosen team’s next question.",
        requiresTarget: true,
        action: (buyerIndex, targetIndex) => {
          teams[buyerIndex].score -= 300;
          // TODO: store a flag for the next question of targetIndex to use forced value
          alert(`${teams[buyerIndex].name} spent $300 to pick ${teams[targetIndex].name}'s next question value!`);
        }
      },
      {
        id: "extendTimer",
        label: "Extend Your Timer",
        cost: 0, // dynamic based on user input
        description: "Purchase extra time (10s increments at 50 pts each) for your next 5 questions.",
        requiresTarget: false,
        action: (buyerIndex) => {
          let increments = prompt("How many 10-second increments? Each costs 50 points.");
          increments = parseInt(increments, 10);
          if (isNaN(increments) || increments < 1) {
            alert("Canceled or invalid number.");
            return;
          }
          const cost = 50 * increments;
          if (teams[buyerIndex].score < cost) {
            alert(`${teams[buyerIndex].name} doesn't have enough points!`);
            return;
          }
          teams[buyerIndex].score -= cost;
          // TODO: track that buyerIndex gets extra timer for next 5 questions
          alert(`${teams[buyerIndex].name} extended timer by ${increments * 10} seconds for the next 5 turns!`);
        }
      },
      {
        id: "connectTeams",
        label: "Connect Teams",
        cost: 200,
        description: "Pay $200 to share future points with another team (both gain half) for 5 turns.",
        requiresTarget: true,
        action: (buyerIndex, targetIndex) => {
          teams[buyerIndex].score -= 200;
          // TODO: track that buyerIndex & targetIndex share points
          alert(`${teams[buyerIndex].name} connected with ${teams[targetIndex].name}! Points will be shared!`);
        }
      }
    ];

    /************************************************************/
    /*                 RENDER TEAM INPUTS, ETC.                 */
    /************************************************************/
    function renderTeamInputs() {
      const container = document.getElementById("teams-container");
      container.innerHTML = "";

      teams.forEach((team, idx) => {
        const row = document.createElement("div");
        row.classList.add("team-input-row");
        row.innerHTML = `<label>Team ${idx + 1}:</label>
         <input type="text" data-index="${idx}" value="${team.name}" oninput="updateTeamName(event)" />`;
        container.appendChild(row);
      });
    }
    function updateTeamName(e) {
      const idx = parseInt(e.target.dataset.index, 10);
      teams[idx].name = e.target.value;
    }
    function addTeam() {
      if (teams.length >= maxTeams) {
        alert("You have reached the maximum number of teams.");
        return;
      }
      teams.push({ name: `Team ${teams.length + 1}`, score: 0 });
      renderTeamInputs();
    }
    function deleteTeam() {
      if (teams.length <= 2) {
        alert("There must be at least 2 teams.");
        return;
      }
      teams.pop();
      renderTeamInputs();
    }

    /************************************************************/
    /*                  FILE UPLOAD & CSV PARSING               */
    /************************************************************/
    document.getElementById("csv-file").addEventListener("change", handleFileUpload);
    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) {
        alert("No file selected");
        return;
      }
      const reader = new FileReader();
      reader.onload = function (e) {
        const contents = e.target.result;
        parseCSV(contents);
        document.getElementById("start-game-button").disabled = false;
      };
      reader.readAsText(file, "UTF-8");
    }
    function parseCSV(contents) {
      const lines = contents.split("\n");
      const headers = lines[0].split(",");
      let dataStartIndex = 0;
      if (headers[0].trim().toLowerCase() === "question") {
        dataStartIndex = 1;
      }
      const data = lines.slice(dataStartIndex);

      questionBank = [];
      data.forEach((line) => {
        if (line.trim() === "") return;
        const fields = parseCSVLine(line);

        const question = fields[0];
        const choice1 = fields[1];
        const choice2 = fields[2];
        const choice3 = fields[3];
        const choice4 = fields[4];
        const answer = fields[5];
        const value = parseInt(fields[6], 10);
        const bonusValue = parseInt(fields[7], 10) || 0;

        let timer = null;
        if (fields.length > 8 && fields[8].trim() !== "") {
          timer = parseInt(fields[8], 10);
          if (isNaN(timer)) {
            console.error("Invalid timer value for question:", question);
            alert("Error: Invalid timer value for question: " + question);
            timer = null;
          }
        }

        let multipleChoice = true;
        if (fields.length > 9 && fields[9].trim() !== "") {
          const mcValue = fields[9].trim().toLowerCase();
          multipleChoice = mcValue === "no" ? false : true;
        }

        if (![100, 200, 300, 400, 500].includes(value)) {
          console.error("Invalid value for question:", question);
          alert("Error: Invalid value for question: " + question);
          return;
        }

        const questionObj = {
          question: question,
          options: [choice1, choice2, choice3, choice4],
          correctIndex: null,
          value: value,
          bonusValue: bonusValue,
          timer: timer,
          multipleChoice: multipleChoice
        };

        const choiceMap = {
          Choice1: 0,
          Choice2: 1,
          Choice3: 2,
          Choice4: 3,
          "1": 0,
          "2": 1,
          "3": 2,
          "4": 3
        };
        const answerKey = answer ? answer.trim() : "";
        const correctIndex = choiceMap[answerKey];

        if (correctIndex === undefined && multipleChoice) {
          console.error("Invalid answer key for question:", question);
          alert("Error: Invalid answer key for question: " + question);
          return;
        } else {
          questionObj.correctIndex = correctIndex;
        }
        questionBank.push(questionObj);
      });
    }
    function parseCSVLine(text) {
      const result = [];
      let current = "";
      let inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        if (inQuotes) {
          if (c === '"') {
            if (text[i + 1] === '"') {
              current += '"';
              i++;
            } else {
              inQuotes = false;
            }
          } else {
            current += c;
          }
        } else {
          if (c === ",") {
            result.push(current);
            current = "";
          } else if (c === '"') {
            inQuotes = true;
          } else {
            current += c;
          }
        }
      }
      result.push(current);
      return result;
    }

    /************************************************************/
    /*                         START GAME                       */
    /************************************************************/
    function goToStartScreen() {
      document.getElementById("instruction-screen").style.display = "none";
      document.getElementById("start-screen").style.display = "flex";
      renderTeamInputs();
    }
    function startGame() {
      if (!questionBank || questionBank.length === 0) {
        alert("Please upload a valid CSV file with questions.");
        return;
      }
      usedQuestions = [];
      currentRound = 1;
      secondChance = false;

      teams.forEach((t) => (t.score = 0));
      teams.forEach((t, idx) => {
        if (!t.name || t.name.trim() === "") {
          t.name = `Team ${idx + 1}`;
        }
      });
      currentTeamIndex = 0;

      document.getElementById("start-screen").style.display = "none";
      document.getElementById("game-board").style.display = "grid";
      document.getElementById("controls").style.display = "flex";

      if (teams.length === 2) {
        document.getElementById("scoreboard").style.display = "flex";
        document.getElementById("scoreboard").classList.remove("hidden");
        document.getElementById("show-scores-button").style.display = "none";
      } else {
        document.getElementById("scoreboard").classList.add("hidden");
        document.getElementById("scoreboard").style.display = "none";
        document.getElementById("show-scores-button").style.display = "block";
      }

      applySettings();
      initializeRound();
      updateScore();
      updateTurnIndicator();
    }

    function initializeRound() {
      selectedQuestions = getQuestionsForRound();
      if (settings.randomBonus) {
        assignRandomBonuses();
      }
      totalQuestions = Object.values(selectedQuestions).reduce((sum, arr) => sum + arr.length, 0);
      remainingQuestions = totalQuestions;
      generateGameBoard();
      updateNextRoundButton();
    }
    function getQuestionsForRound() {
      const pointValues = [100, 200, 300, 400, 500];
      const selected = { 100: [], 200: [], 300: [], 400: [], 500: [] };
      const unused = questionBank.filter((q) => !usedQuestions.includes(q));

      pointValues.forEach((val) => {
        const group = unused.filter((q) => q.value === val);
        if (group.length > 5) {
          selected[val] = getRandomQuestions(group, 5);
        } else {
          selected[val] = group.slice();
        }
        usedQuestions.push(...selected[val]);
      });
      return selected;
    }
    function getRandomQuestions(array, n) {
      const result = [];
      const cloned = array.slice();
      for (let i = 0; i < n && cloned.length > 0; i++) {
        const randomIndex = Math.floor(Math.random() * cloned.length);
        result.push(cloned.splice(randomIndex, 1)[0]);
      }
      return result;
    }
    function assignRandomBonuses() {
      const allQ = Object.values(selectedQuestions).flat();
      allQ.forEach((q) => {
        const rand = Math.random() * 100;
        if (rand < settings.bonusChance) {
          q.bonusValue = (q.bonusValue || 0) + settings.bonusPoints;
        }
      });
    }
    function generateGameBoard() {
      const board = document.getElementById("game-board");
      board.innerHTML = "";

      const pointValues = [100, 200, 300, 400, 500];
      for (let row = 0; row < 5; row++) {
        const val = pointValues[row];
        const arr = selectedQuestions[val];
        for (let col = 0; col < 5; col++) {
          const qObj = arr[col];
          const div = document.createElement("div");
          div.classList.add("question");
          if (qObj) {
            div.dataset.value = qObj.value;
            div.onclick = () => selectQuestion(div, qObj);
            div.innerText = `$${qObj.value}`;
          } else {
            div.classList.add("answered");
            div.innerText = "";
          }
          board.appendChild(div);
        }
      }
    }
    function selectQuestion(element, questionObj) {
      if (element.classList.contains("answered")) return;
      element.classList.add("answered");
      element.innerText = "";
      remainingQuestions--;

      document.getElementById("current-team").innerText = `Question for ${teams[currentTeamIndex].name}`;
      document.getElementById("question-text").innerText = questionObj.question;
      document.getElementById("question-text").style.color = settings.colors.questionTextColor;
      document.getElementById("modal").style.display = "flex";
      document.getElementById("modal").dataset.value = questionObj.value;
      document.getElementById("modal").dataset.bonusValue = questionObj.bonusValue || 0;
      document.getElementById("modal").dataset.correctIndex = questionObj.correctIndex;
      document.getElementById("modal").dataset.questionObj = JSON.stringify(questionObj);

      const opts = document.getElementById("options");
      opts.innerHTML = "";
      document.getElementById("start-timer-button").style.display = "inline-block";
      document.getElementById("timer-display").innerText = "";

      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      answerStartTime = Date.now();

      if (settings.enableStopwatch && !stopwatchRunning) startStopwatch();
      if (settings.enableGameClock && !gameClockRunning) startGameClock();
      if (settings.enableEndTime && !endTimeRunning) startEndTimeCheck();
    }

    /************************************************************/
    /*                        ANSWERING LOGIC                   */
    /************************************************************/
    function startTimer() {
      document.getElementById("start-timer-button").style.display = "none";
      const questionObj = JSON.parse(document.getElementById("modal").dataset.questionObj);
      if (questionObj.timer && !isNaN(questionObj.timer)) {
        timeRemaining = questionObj.timer;
      } else {
        const val = parseInt(document.getElementById("modal").dataset.value);
        const times = { 100: 10, 200: 15, 300: 20, 400: 25, 500: 30 };
        timeRemaining = times[val];
      }

      const opts = document.getElementById("options");
      opts.innerHTML = "";
      if (questionObj.multipleChoice) {
        questionObj.options.forEach((option, i) => {
          const button = document.createElement("button");
          button.innerText = option;
          button.onclick = () => checkAnswer(i);
          opts.appendChild(button);
        });
      } else {
        const correctButton = document.createElement("button");
        correctButton.innerText = "Correct";
        correctButton.classList.add("correct-button");
        correctButton.onclick = () => checkAnswer("correct");
        opts.appendChild(correctButton);

        const incorrectButton = document.createElement("button");
        incorrectButton.innerText = "Incorrect";
        incorrectButton.classList.add("incorrect-button");
        incorrectButton.onclick = () => checkAnswer("incorrect");
        opts.appendChild(incorrectButton);
      }

      document.getElementById("timer-display").innerText = `Time Remaining: ${timeRemaining} seconds`;
      timerInterval = setInterval(() => {
        timeRemaining--;
        if (timeRemaining > 0) {
          document.getElementById("timer-display").innerText = `Time Remaining: ${timeRemaining} seconds`;
        } else {
          clearInterval(timerInterval);
          timerInterval = null;
          document.getElementById("timer-display").innerText = "Time's up!";
          disableOptions();
          timeUpHandler();
        }
      }, 1000);
    }
    function disableOptions() {
      const opts = document.getElementById("options");
      const buttons = opts.getElementsByTagName("button");
      for (let b of buttons) {
        b.disabled = true;
      }
    }
    function checkAnswer(selectedIndex) {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      const correctIndex = parseInt(document.getElementById("modal").dataset.correctIndex);
      const value = parseInt(document.getElementById("modal").dataset.value);
      const bonusValue = parseInt(document.getElementById("modal").dataset.bonusValue) || 0;
      const totalPoints = value + bonusValue;
      const currentTeam = teams[currentTeamIndex];
      const questionObj = JSON.parse(document.getElementById("modal").dataset.questionObj);

      let isCorrect = false;
      if (questionObj.multipleChoice) {
        isCorrect = selectedIndex === correctIndex;
      } else {
        isCorrect = selectedIndex === "correct";
      }

      let resultMessage = "";
      if (isCorrect) {
        currentTeam.score += totalPoints;
        if (bonusValue > 0) {
          resultMessage = `Correct! +$${value} + Bonus $${bonusValue} for ${currentTeam.name}.`;
        } else {
          resultMessage = `Correct! +$${value} for ${currentTeam.name}.`;
        }
        secondChance = false;
        closeModal();
        showResult(resultMessage);
        nextTeam();
        checkEndGame();
      } else {
        const penalty = getPenalty(currentRound, value);
        currentTeam.score -= penalty;
        if (currentTeam.score <= -500) currentTeam.score = 0;
        resultMessage = `Incorrect! -$${penalty} for ${currentTeam.name}.`;

        if (teams.length === 2) {
          if (!secondChance) {
            secondChance = true;
            currentTeamIndex = (currentTeamIndex + 1) % teams.length;
            resultMessage += ` Passing to ${teams[currentTeamIndex].name}.`;
            showResult(resultMessage);
            updateScore();
            updateTurnIndicator();
          } else {
            secondChance = false;
            closeModal();
            showResult(resultMessage);
            nextTeam();
            checkEndGame();
          }
        } else {
          closeModal();
          showResult(resultMessage);
          nextTeam();
          checkEndGame();
        }
      }
      updateScore();
    }
    function timeUpHandler() {
      const value = parseInt(document.getElementById("modal").dataset.value);
      const currentTeam = teams[currentTeamIndex];
      const penalty = getPenalty(currentRound, value);
      currentTeam.score -= penalty;
      if (currentTeam.score <= -500) currentTeam.score = 0;

      let resultMessage = `Time's up! -$${penalty} for ${currentTeam.name}.`;
      if (teams.length === 2) {
        if (!secondChance) {
          secondChance = true;
          currentTeamIndex = (currentTeamIndex + 1) % teams.length;
          resultMessage += ` Passing to ${teams[currentTeamIndex].name}.`;
          showResult(resultMessage);
          updateScore();
          updateTurnIndicator();
        } else {
          secondChance = false;
          closeModal();
          showResult(resultMessage);
          nextTeam();
          checkEndGame();
        }
      } else {
        closeModal();
        showResult(resultMessage);
        nextTeam();
        checkEndGame();
      }
      updateScore();
    }
    function getPenalty(round, questionValue) {
      if (round === 1) {
        return Math.floor(questionValue / 2);
      }
      return questionValue * (round - 1);
    }
    function nextTeam() {
      currentTeamIndex = (currentTeamIndex + 1) % teams.length;
      updateTurnIndicator();
    }

    /************************************************************/
    /*                       END GAME LOGIC                     */
    /************************************************************/
    function checkEndGame() {
      if (remainingQuestions <= 0) {
        if (settings.useRounds && canProceedToNextRound()) {
          showNextRoundPrompt();
        } else {
          endGame();
        }
      }
    }
    function endGameEarly() {
      remainingQuestions = 0;
      document.querySelectorAll(".question").forEach((el) => {
        el.classList.add("answered");
        el.innerText = "";
      });
      checkEndGame();
    }
    function canProceedToNextRound() {
      const unused = questionBank.filter((q) => !usedQuestions.includes(q));
      if (settings.useRounds) {
        return currentRound < settings.maxRounds && unused.length >= 25;
      }
      return false;
    }
    function updateNextRoundButton() {
      const btn = document.getElementById("next-round-button");
      if (currentRound < settings.maxRounds && canProceedToNextRound()) {
        btn.style.display = "inline-block";
      } else {
        btn.style.display = "none";
      }
    }
    function goToNextRound() {
      if (canProceedToNextRound()) {
        currentRound++;
        initializeRound();
        updateRoundIndicator();
      } else {
        alert("Not enough questions for the next round or maximum rounds reached.");
      }
    }
    function showNextRoundPrompt() {
      if (canProceedToNextRound()) {
        const proceed = confirm("Do you want to proceed to the next round?");
        if (proceed) {
          currentRound++;
          initializeRound();
          updateRoundIndicator();
        } else {
          endGame();
        }
      } else {
        endGame();
      }
    }
    function updateRoundIndicator() {
      if (teams.length === 2 && settings.useRounds) {
        document.getElementById("turn-indicator").innerText = `Turn: ${
          teams[currentTeamIndex].name
        } (Round ${currentRound})`;
      } else if (teams.length === 2) {
        document.getElementById("turn-indicator").innerText = `Turn: ${teams[currentTeamIndex].name}`;
      }
    }
    function endGame() {
      let winner = teams[0];
      for (let i = 1; i < teams.length; i++) {
        if (teams[i].score > winner.score) {
          winner = teams[i];
        }
      }
      const topScore = winner.score;
      const tiedTeams = teams.filter((t) => t.score === topScore);
      let message = "";
      if (tiedTeams.length === 1) {
        message = `${winner.name} has won with a score of $${winner.score}!`;
      } else {
        const names = tiedTeams.map((t) => t.name).join(", ");
        message = `It's a tie among ${names}, each with a score of $${topScore}!`;
      }
      document.getElementById("end-game-message").innerText = message;
      document.getElementById("end-game-modal").style.display = "flex";

      stopStopwatch();
      stopGameClock();
      stopEndTimeCheck();
    }
    function playNewGame() {
      teams.forEach((t) => (t.score = 0));
      currentTeamIndex = 0;
      secondChance = false;
      remainingQuestions = totalQuestions;
      document.getElementById("game-board").innerHTML = "";
      document.getElementById("start-screen").style.display = "none";
      document.getElementById("instruction-screen").style.display = "flex";
      document.getElementById("scoreboard").style.display = "none";
      document.getElementById("controls").style.display = "none";
      updateScore();
      resetStopwatch();
      resetGameClock();
      resetEndTimeCheck();
    }

    /************************************************************/
    /*                          MODALS                          */
    /************************************************************/
    function showResult(msg) {
      document.getElementById("result-message").innerText = msg;
      document.getElementById("result-modal").style.display = "flex";
    }
    function closeResultModal() {
      document.getElementById("result-modal").style.display = "none";
      if (secondChance && teams.length === 2) {
        document.getElementById("current-team").innerText = `Question for ${teams[currentTeamIndex].name}`;
        document.getElementById("modal").style.display = "flex";
        document.getElementById("timer-display").innerText = "";
        document.getElementById("start-timer-button").style.display = "inline-block";
        document.getElementById("options").innerHTML = "";
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }
    }
    function closeModal() {
      document.getElementById("modal").style.display = "none";
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }
    function updateScore() {
      if (teams.length === 2) {
        document.getElementById("team1-score").innerText = `${teams[0].name}: $${teams[0].score}`;
        document.getElementById("team2-score").innerText = `${teams[1].name}: $${teams[1].score}`;
      }
    }
    function updateTurnIndicator() {
      if (teams.length === 2) {
        if (settings.useRounds) {
          document.getElementById("turn-indicator").innerText = `Turn: ${
            teams[currentTeamIndex].name
          } (Round ${currentRound})`;
        } else {
          document.getElementById("turn-indicator").innerText = `Turn: ${teams[currentTeamIndex].name}`;
        }
      }
    }
    function openScoreboardModal() {
      const container = document.getElementById("all-teams-score");
      container.innerHTML = "";
      teams.forEach((team) => {
        const line = document.createElement("div");
        line.textContent = `${team.name}: $${team.score}`;
        container.appendChild(line);
      });
      document.getElementById("scoreboard-modal").style.display = "flex";
    }
    function closeScoreboardModal() {
      document.getElementById("scoreboard-modal").style.display = "none";
    }

    /************************************************************/
    /*                       STOPWATCH                          */
    /************************************************************/
    function startStopwatch() {
      if (!stopwatchRunning) {
        stopwatchRunning = true;
        const startTime = Date.now() - stopwatchTime;
        stopwatchInterval = setInterval(() => {
          stopwatchTime = Date.now() - startTime;
          updateStopwatchDisplay();
        }, 1000);
      }
    }
    function stopStopwatch() {
      if (stopwatchRunning) {
        clearInterval(stopwatchInterval);
        stopwatchRunning = false;
      }
    }
    function resetStopwatch() {
      stopStopwatch();
      stopwatchTime = 0;
      updateStopwatchDisplay();
    }
    function updateStopwatchDisplay() {
      const hours = Math.floor(stopwatchTime / 3600000);
      const minutes = Math.floor((stopwatchTime % 3600000) / 60000);
      const seconds = Math.floor((stopwatchTime % 60000) / 1000);
      document.getElementById("stopwatch-time").innerText = `${hours
        .toString()
        .padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds
        .toString()
        .padStart(2, "0")}`;
    }

    /************************************************************/
    /*                       GAME CLOCK                         */
    /************************************************************/
    let gameClockWarned = false;
    function startGameClock() {
      if (!gameClockRunning) {
        gameClockRunning = true;
        gameClockTimeRemaining = settings.gameClockMinutes * 60000;
        const startTime = Date.now();
        gameClockWarned = false;
        gameClockInterval = setInterval(() => {
          const elapsed = Date.now() - startTime;
          gameClockTimeRemaining = settings.gameClockMinutes * 60000 - elapsed;

          if (gameClockTimeRemaining <= 0) {
            clearInterval(gameClockInterval);
            gameClockRunning = false;
            gameClockTimeRemaining = 0;
            handleGameClockEnd();
          } else {
            if (settings.warnFiveMinutes && gameClockTimeRemaining <= 300000 && !gameClockWarned) {
              gameClockWarned = true;
              alert("Warning: Only 5 minutes left on the game clock!");
            }
          }
        }, 1000);
      }
    }
    function stopGameClock() {
      if (gameClockRunning) {
        clearInterval(gameClockInterval);
        gameClockRunning = false;
      }
    }
    function resetGameClock() {
      stopGameClock();
      gameClockTimeRemaining = 0;
      gameClockWarned = false;
    }
    function handleGameClockEnd() {
      if (!secondChance) {
        setTimeout(() => {
          document.getElementById("game-clock-modal-title").innerText = "Game Clock Time Up";
          document.getElementById("game-clock-modal").style.display = "flex";
        }, 1000);
      }
    }
    function addTime(minutes) {
      settings.gameClockMinutes += minutes;
      gameClockWarned = false;
      startGameClock();
      document.getElementById("game-clock-modal").style.display = "none";
    }
    function showCustomTimeInput() {
      document.getElementById("custom-time-input").style.display = "block";
    }
    function addCustomTime() {
      const mins = parseInt(document.getElementById("custom-time-minutes").value, 10);
      if (isNaN(mins) || mins <= 0) {
        alert("Please enter a valid number of minutes.");
        return;
      }
      addTime(mins);
      document.getElementById("custom-time-input").style.display = "none";
      document.getElementById("custom-time-minutes").value = "";
    }
    function turnOffGameClock() {
      settings.enableGameClock = false;
      stopGameClock();
      document.getElementById("game-clock-modal").style.display = "none";
    }

    /************************************************************/
    /*                         END TIME                         */
    /************************************************************/
    function startEndTimeCheck() {
      if (!endTimeRunning) {
        endTimeRunning = true;
        const now = new Date();
        const [hh, mm] = settings.endTime.split(":");
        const endDate = new Date();
        endDate.setHours(parseInt(hh, 10), parseInt(mm, 10), 0, 0);

        if (endDate <= now) {
          endDate.setDate(endDate.getDate() + 1);
        }
        endTimeWarned = false;

        endTimeInterval = setInterval(() => {
          const remaining = endDate - new Date();
          if (remaining <= 0) {
            clearInterval(endTimeInterval);
            endTimeRunning = false;
            handleEndTimeReached();
          } else if (settings.warnFiveMinutesEndTime && remaining <= 300000 && !endTimeWarned) {
            endTimeWarned = true;
            alert("Warning: Only 5 minutes left before the end time!");
          }
        }, 1000);
      }
    }
    function stopEndTimeCheck() {
      if (endTimeRunning) {
        clearInterval(endTimeInterval);
        endTimeRunning = false;
      }
    }
    function resetEndTimeCheck() {
      stopEndTimeCheck();
      endTimeWarned = false;
    }
    function handleEndTimeReached() {
      if (!secondChance) {
        setTimeout(() => {
          document.getElementById("game-clock-modal-title").innerText = "End Time Reached";
          document.getElementById("game-clock-modal").style.display = "flex";
        }, 1000);
      }
    }

    /************************************************************/
    /*                      SETTINGS LOGIC                      */
    /************************************************************/
    function openSettings() {
      if (settings.enableStopwatch) stopStopwatch();
      if (settings.enableGameClock) stopGameClock();
      if (settings.enableEndTime) stopEndTimeCheck();

      document.getElementById("background-color-picker").value = settings.colors.backgroundColor;
      document.getElementById("grid-cell-color-picker").value = settings.colors.gridCellColor;
      document.getElementById("button-color-picker").value = settings.colors.buttonColor;
      document.getElementById("text-color-picker").value = settings.colors.textColor;
      document.getElementById("question-text-color-picker").value = settings.colors.questionTextColor;
      document.getElementById("use-rounds-checkbox").checked = settings.useRounds;
      document.getElementById("variable-rounds-checkbox").checked = settings.variableRounds;
      document.getElementById("random-bonus-checkbox").checked = settings.randomBonus;
      document.getElementById("enable-stopwatch-checkbox").checked = settings.enableStopwatch;
      document.getElementById("enable-gameclock-checkbox").checked = settings.enableGameClock;
      document.getElementById("gameclock-minutes-input").value = settings.gameClockMinutes;
      document.getElementById("warn-five-minutes-checkbox").checked = settings.warnFiveMinutes;
      document.getElementById("enable-endtime-checkbox").checked = settings.enableEndTime;
      document.getElementById("endtime-input").value = settings.endTime || "";
      document.getElementById("warn-five-minutes-endtime-checkbox").checked = settings.warnFiveMinutesEndTime;
      document.getElementById("enable-superpowers-checkbox").checked = settings.superpowersEnabled;

      toggleBonusSettings();
      toggleGameClockSettings();
      toggleEndTimeSettings();
      toggleMaxRoundsSettings();

      if (settings.randomBonus) {
        document.getElementById("bonus-points-input").value = settings.bonusPoints;
        document.getElementById("bonus-chance-input").value = settings.bonusChance;
      }
      if (settings.enableStopwatch) {
        document.getElementById("stopwatch-display").style.display = "block";
        updateStopwatchDisplay();
      } else {
        document.getElementById("stopwatch-display").style.display = "none";
      }
      document.getElementById("settings-modal").style.display = "flex";
    }
    function closeSettings() {
      document.getElementById("settings-modal").style.display = "none";
      if (settings.enableStopwatch && !stopwatchRunning) startStopwatch();
      if (settings.enableGameClock && !gameClockRunning) startGameClock();
      if (settings.enableEndTime && !endTimeRunning) startEndTimeCheck();
    }
    function toggleBonusSettings() {
      const bs = document.getElementById("bonus-settings");
      if (document.getElementById("random-bonus-checkbox").checked) {
        bs.style.display = "block";
      } else {
        bs.style.display = "none";
      }
    }
    function toggleMaxRoundsSettings() {
      const rs = document.getElementById("rounds-settings");
      if (document.getElementById("variable-rounds-checkbox").checked) {
        rs.style.display = "block";
      } else {
        rs.style.display = "none";
      }
    }
    function toggleGameClockSettings() {
      const gcs = document.getElementById("gameclock-settings");
      if (document.getElementById("enable-gameclock-checkbox").checked) {
        gcs.style.display = "block";
        document.getElementById("enable-endtime-checkbox").checked = false;
        settings.enableEndTime = false;
        toggleEndTimeSettings();
      } else {
        gcs.style.display = "none";
      }
    }
    function toggleEndTimeSettings() {
      const ets = document.getElementById("endtime-settings");
      if (document.getElementById("enable-endtime-checkbox").checked) {
        ets.style.display = "block";
        document.getElementById("enable-gameclock-checkbox").checked = false;
        settings.enableGameClock = false;
        toggleGameClockSettings();
      } else {
        ets.style.display = "none";
      }
    }
    document.getElementById("random-bonus-checkbox").addEventListener("change", toggleBonusSettings);
    document.getElementById("enable-gameclock-checkbox").addEventListener("change", toggleGameClockSettings);
    document.getElementById("enable-endtime-checkbox").addEventListener("change", toggleEndTimeSettings);
    document.getElementById("variable-rounds-checkbox").addEventListener("change", toggleMaxRoundsSettings);

    function saveSettings(e) {
      e.preventDefault();
      settings.colors.backgroundColor = document.getElementById("background-color-picker").value;
      settings.colors.gridCellColor = document.getElementById("grid-cell-color-picker").value;
      settings.colors.buttonColor = document.getElementById("button-color-picker").value;
      settings.colors.textColor = document.getElementById("text-color-picker").value;
      settings.colors.questionTextColor = document.getElementById("question-text-color-picker").value;
      settings.useRounds = document.getElementById("use-rounds-checkbox").checked;
      settings.variableRounds = document.getElementById("variable-rounds-checkbox").checked;
      if (settings.variableRounds) {
        settings.maxRounds = parseInt(document.getElementById("max-rounds-input").value, 10) || 3;
      } else {
        settings.maxRounds = settings.useRounds ? 3 : 1;
      }
      settings.randomBonus = document.getElementById("random-bonus-checkbox").checked;
      settings.enableStopwatch = document.getElementById("enable-stopwatch-checkbox").checked;
      settings.enableGameClock = document.getElementById("enable-gameclock-checkbox").checked;
      settings.gameClockMinutes = parseInt(document.getElementById("gameclock-minutes-input").value, 10) || 60;
      settings.warnFiveMinutes = document.getElementById("warn-five-minutes-checkbox").checked;
      settings.enableEndTime = document.getElementById("enable-endtime-checkbox").checked;
      settings.endTime = document.getElementById("endtime-input").value || null;
      settings.warnFiveMinutesEndTime =
        document.getElementById("warn-five-minutes-endtime-checkbox").checked;
      settings.superpowersEnabled = document.getElementById("enable-superpowers-checkbox").checked;

      if (settings.randomBonus) {
        settings.bonusPoints = parseInt(document.getElementById("bonus-points-input").value, 10) || 0;
        settings.bonusChance = parseInt(document.getElementById("bonus-chance-input").value, 10) || 0;
      } else {
        settings.bonusPoints = 0;
        settings.bonusChance = 0;
      }
      applySettings();
      closeSettings();
    }
    function applySettings() {
      document.documentElement.style.setProperty("--background-color", settings.colors.backgroundColor);
      document.documentElement.style.setProperty("--grid-cell-color", settings.colors.gridCellColor);
      document.documentElement.style.setProperty("--button-color", settings.colors.buttonColor);
      document.documentElement.style.setProperty("--text-color", settings.colors.textColor);
      document.documentElement.style.setProperty("--question-text-color", settings.colors.questionTextColor);

      if (!settings.useRounds) {
        maxRounds = 1;
        currentRound = 1;
      } else if (settings.variableRounds) {
        maxRounds = settings.maxRounds;
      } else {
        maxRounds = 3;
      }
      if (document.getElementById("game-board").style.display === "grid") {
        updateNextRoundButton();
        updateTurnIndicator();
      }
      // Show or hide superpowers button
      const superButton = document.getElementById("superpowers-button");
      if (superButton) {
        superButton.style.display = settings.superpowersEnabled ? "inline-block" : "none";
      }
    }

    /************************************************************/
    /*               OPEN/CLOSE SUPERPOWERS MODAL               */
    /************************************************************/
    function openSuperpowersModal() {
      const container = document.getElementById("superpowers-list");
      container.innerHTML = "";

      SUPERPOWERS.forEach((sp) => {
        // Make a "card" with border/padding
        const card = document.createElement("div");
        card.style.border = "1px solid #999";
        card.style.padding = "12px";
        card.style.margin = "10px 0";
        card.style.borderRadius = "6px";

        // Title (label + cost if any)
        const title = document.createElement("h3");
        title.textContent = sp.label + (sp.cost > 0 ? ` ($${sp.cost})` : " (Free)");
        card.appendChild(title);

        // Description
        const desc = document.createElement("p");
        desc.style.fontSize = "0.9em";
        desc.textContent = sp.description;
        card.appendChild(desc);

        let targetIndex = null;

        // If requiresTarget, build a dropdown of other teams (excluding buyer)
        if (sp.requiresTarget) {
          const targetLabel = document.createElement("label");
          targetLabel.textContent = "Choose Target: ";
          const targetSelect = document.createElement("select");

          teams.forEach((team, idx) => {
            if (idx !== currentTeamIndex) {
              const opt = document.createElement("option");
              opt.value = idx;
              opt.text = team.name;
              targetSelect.appendChild(opt);
            }
          });

          if (targetSelect.options.length === 0) {
            // No valid other teams found
            targetSelect.disabled = true;
          }
          targetLabel.appendChild(targetSelect);
          card.appendChild(targetLabel);
        }

        const btn = document.createElement("button");
        btn.textContent = "Activate";
        btn.onclick = () => {
          if (sp.requiresTarget) {
            const sel = card.querySelector("select");
            if (!sel || sel.disabled) {
              alert("No valid target available.");
              return;
            }
            targetIndex = parseInt(sel.value, 10);
            if (targetIndex === currentTeamIndex) {
              alert("You cannot target yourself with this superpower!");
              return;
            }
          }

          // Check cost if > 0 (or handle special for "extendTimer")
          if (sp.id !== "extendTimer" && sp.cost > 0) {
            if (teams[currentTeamIndex].score < sp.cost) {
              alert(`${teams[currentTeamIndex].name} doesn't have enough points for that superpower!`);
              return;
            }
          }

          // Execute
          if (sp.requiresTarget) {
            sp.action(currentTeamIndex, targetIndex);
          } else {
            sp.action(currentTeamIndex);
          }

          // Immediately end buyer's turn
          alert(`Turn ends for ${teams[currentTeamIndex].name} because they used a superpower.`);
          closeSuperpowersModal();
          nextTeam();
        };
        card.appendChild(btn);

        container.appendChild(card);
      });

      document.getElementById("superpowers-modal").style.display = "flex";
    }

    function closeSuperpowersModal() {
      document.getElementById("superpowers-modal").style.display = "none";
    }

    /************************************************************/
    /*                   OUTSIDE-CLICK HANDLERS                 */
    /************************************************************/
    window.onclick = function (event) {
      if (event.target == document.getElementById("modal")) closeModal();
      if (event.target == document.getElementById("result-modal")) closeResultModal();
      if (event.target == document.getElementById("end-game-modal")) {
        document.getElementById("end-game-modal").style.display = "none";
        playNewGame();
      }
      if (event.target == document.getElementById("settings-modal")) {
        closeSettings();
      }
      if (event.target == document.getElementById("game-clock-modal")) {
        document.getElementById("game-clock-modal").style.display = "none";
      }
      if (event.target == document.getElementById("scoreboard-modal")) {
        closeScoreboardModal();
      }
      if (event.target == document.getElementById("superpowers-modal")) {
        closeSuperpowersModal();
      }
    };
  </script>
</body>
</html>
